{
  "slug": "observatory-daily-publication",
  "name": "Observatory Visualization & Reports",
  "version": 1,
  "description": "Generates plots from Timestore partitions and publishes minute-level status reports with optional Metastore upserts.",
  "parametersSchema": {
    "type": "object",
    "properties": {
      "timestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "timestoreDatasetSlug": {
        "type": "string",
        "minLength": 1
      },
      "timestoreAuthToken": {
        "type": "string"
      },
      "partitionKey": {
        "type": "string",
        "minLength": 1
      },
      "instrumentId": {
        "type": "string"
      },
      "lookbackMinutes": {
        "type": "number",
        "minimum": 1,
        "maximum": 10080
      },
      "siteFilter": {
        "type": "string"
      },
      "reportTemplate": {
        "type": "string"
      },
      "metastoreBaseUrl": {
        "type": "string"
      },
      "metastoreAuthToken": {
        "type": "string"
      },
      "metastoreNamespace": {
        "type": "string"
      },
      "visualizationsPrefix": {
        "type": "string",
        "minLength": 1
      },
      "reportsPrefix": {
        "type": "string",
        "minLength": 1
      },
      "filestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "filestoreBackendId": {
        "type": [
          "integer",
          "null"
        ],
        "minimum": 1
      },
      "filestoreToken": {
        "type": "string"
      },
      "filestorePrincipal": {
        "type": "string"
      },
      "filestoreBackendKey": {
        "type": "string",
        "minLength": 1
      }
    },
    "required": [
      "timestoreBaseUrl",
      "timestoreDatasetSlug",
      "partitionKey",
      "instrumentId",
      "visualizationsPrefix",
      "reportsPrefix",
      "filestoreBaseUrl",
      "filestoreBackendKey"
    ]
  },
  "defaultParameters": {
    "lookbackMinutes": 180,
    "timestoreBaseUrl": "http://127.0.0.1:4200",
    "timestoreDatasetSlug": "observatory-timeseries",
    "metastoreBaseUrl": "http://127.0.0.1:4100",
    "metastoreNamespace": "observatory.reports",
    "timestoreAuthToken": null,
    "metastoreAuthToken": null,
    "instrumentId": null,
    "visualizationsPrefix": "datasets/observatory/visualizations",
    "reportsPrefix": "datasets/observatory/reports",
    "filestoreBaseUrl": "http://127.0.0.1:4300",
    "filestoreBackendId": 1,
    "filestoreToken": null,
    "filestorePrincipal": null,
    "filestoreBackendKey": "observatory-event-driven-s3"
  },
  "steps": [
    {
      "id": "generate-plots",
      "name": "Generate observatory plots",
      "type": "job",
      "jobSlug": "observatory-visualization-runner",
      "parameters": {
        "timestoreBaseUrl": "{{ parameters.timestoreBaseUrl }}",
        "timestoreDatasetSlug": "{{ parameters.timestoreDatasetSlug }}",
        "timestoreAuthToken": "{{ parameters.timestoreAuthToken }}",
        "partitionKey": "{{ parameters.partitionKey }}",
        "instrumentId": "{{ parameters.instrumentId }}",
        "lookbackMinutes": "{{ parameters.lookbackMinutes }}",
        "siteFilter": "{{ parameters.siteFilter }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "filestorePrincipal": "{{ parameters.filestorePrincipal }}",
        "visualizationsPrefix": "{{ parameters.visualizationsPrefix }}",
        "filestoreBackendKey": "{{ parameters.filestoreBackendKey }}"
      },
      "storeResultAs": "visualizations",
      "consumes": [
        {
          "assetId": "observatory.timeseries.timestore"
        }
      ],
      "produces": [
        {
          "assetId": "observatory.visualizations.minute",
          "freshness": {
            "ttlMs": 86400000
          },
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 6
          },
          "schema": {
            "type": "object",
            "properties": {
              "generatedAt": {
                "type": "string",
                "format": "date-time"
              },
              "partitionKey": {
                "type": "string"
              },
              "storagePrefix": {
                "type": "string"
              },
              "lookbackMinutes": {
                "type": "number"
              },
              "artifacts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "string"
                    },
                    "nodeId": {
                      "type": "number"
                    },
                    "mediaType": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    },
                    "sizeBytes": {
                      "type": "number"
                    },
                    "checksum": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "path",
                    "mediaType"
                  ]
                }
              },
              "metrics": {
                "type": "object",
                "additionalProperties": true
              }
            },
            "required": [
              "generatedAt",
              "partitionKey",
              "storagePrefix",
              "artifacts"
            ]
          }
        }
      ]
    },
    {
      "id": "publish-report",
      "name": "Publish status report",
      "type": "job",
      "jobSlug": "observatory-report-publisher",
      "dependsOn": [
        "generate-plots"
      ],
      "parameters": {
        "partitionKey": "{{ parameters.partitionKey }}",
        "instrumentId": "{{ parameters.instrumentId }}",
        "reportTemplate": "{{ parameters.reportTemplate }}",
        "visualizationAsset": "{{ shared.visualizations.visualization }}",
        "metastoreBaseUrl": "{{ parameters.metastoreBaseUrl }}",
        "metastoreAuthToken": "{{ parameters.metastoreAuthToken }}",
        "metastoreNamespace": "{{ parameters.metastoreNamespace }}",
        "reportsPrefix": "{{ parameters.reportsPrefix }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "filestorePrincipal": "{{ parameters.filestorePrincipal }}",
        "filestoreBackendKey": "{{ parameters.filestoreBackendKey }}"
      },
      "consumes": [
        {
          "assetId": "observatory.visualizations.minute"
        }
      ],
      "produces": [
        {
          "assetId": "observatory.reports.status",
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 7
          },
          "schema": {
            "type": "object",
            "properties": {
              "generatedAt": {
                "type": "string",
                "format": "date-time"
              },
              "storagePrefix": {
                "type": "string"
              },
              "reportFiles": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "string"
                    },
                    "nodeId": {
                      "type": "number"
                    },
                    "mediaType": {
                      "type": "string"
                    },
                    "sizeBytes": {
                      "type": "number"
                    },
                    "checksum": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "path",
                    "mediaType"
                  ]
                }
              },
              "summary": {
                "type": "object",
                "properties": {
                  "instrumentCount": {
                    "type": "number"
                  },
                  "siteCount": {
                    "type": "number"
                  },
                  "alertCount": {
                    "type": "number"
                  }
                }
              },
              "plotsReferenced": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "string"
                    },
                    "altText": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "path"
                  ]
                }
              },
              "instrumentId": {
                "type": "string"
              }
            },
            "required": [
              "generatedAt",
              "storagePrefix",
              "reportFiles"
            ]
          }
        }
      ]
    }
  ],
  "triggers": [
    {
      "type": "manual"
    }
  ],
  "metadata": {
    "provisioning": {
      "eventTriggers": [
        {
          "name": "Observatory publication on observatory partition",
          "description": "Generate plots and publish observatory reports when the ingest workflow emits a partition-ready event.",
          "eventType": "observatory.minute.partition-ready",
          "eventSource": "observatory.timestore-loader",
          "predicates": [
            {
              "path": "$.payload.datasetSlug",
              "operator": "equals",
              "value": "{{ defaultParameters.timestoreDatasetSlug }}"
            }
          ],
          "parameterTemplate": {
            "partitionKey": "{{ event.payload.partitionKeyFields.window | default: event.payload.minute | default: event.payload.partitionKey }}",
            "instrumentId": "{{ event.payload.instrumentId | default: 'unknown' }}",
            "minute": "{{ event.payload.minute }}",
            "rowsIngested": "{{ event.payload.rowsIngested }}",
            "timestoreBaseUrl": "{{ trigger.metadata.timestore.baseUrl }}",
            "timestoreDatasetSlug": "{{ trigger.metadata.timestore.datasetSlug }}",
            "timestoreAuthToken": "{{ trigger.metadata.timestore.authToken }}",
            "metastoreBaseUrl": "{{ trigger.metadata.metastore.baseUrl }}",
            "metastoreNamespace": "{{ trigger.metadata.metastore.namespace }}",
            "metastoreAuthToken": "{{ trigger.metadata.metastore.authToken }}",
            "visualizationsPrefix": "{{ trigger.metadata.paths.visualizationsPrefix }}",
            "reportsPrefix": "{{ trigger.metadata.paths.reportsPrefix }}",
            "filestoreBaseUrl": "{{ trigger.metadata.filestore.baseUrl }}",
            "filestoreBackendId": "{{ trigger.metadata.filestore.backendMountId }}",
            "filestoreBackendKey": "{{ trigger.metadata.filestore.backendMountKey }}"
          },
          "runKeyTemplate": "observatory-publish-{{ parameters.instrumentId | replace: ':', '-' }}-{{ parameters.partitionKey | replace: ':', '-' }}",
          "metadata": {
            "timestore": {
              "baseUrl": "{{ defaultParameters.timestoreBaseUrl }}",
              "datasetSlug": "{{ defaultParameters.timestoreDatasetSlug }}",
              "authToken": "{{ defaultParameters.timestoreAuthToken }}"
            },
            "paths": {
              "visualizationsPrefix": "{{ defaultParameters.visualizationsPrefix }}",
              "reportsPrefix": "{{ defaultParameters.reportsPrefix }}"
            },
            "metastore": {
              "baseUrl": "{{ defaultParameters.metastoreBaseUrl }}",
              "namespace": "{{ defaultParameters.metastoreNamespace }}",
              "authToken": "{{ defaultParameters.metastoreAuthToken }}"
            }
          },
          "idempotencyKeyExpression": "{{ event.payload.instrumentId | default: 'unknown' | replace: ':', '-' }}-{{ event.payload.partitionKey | replace: ':', '-' }}",
          "status": "active"
        }
      ]
    }
  }
}
