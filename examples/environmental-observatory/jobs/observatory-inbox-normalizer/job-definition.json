{
  "slug": "observatory-inbox-normalizer",
  "name": "Observatory Inbox Normalizer",
  "type": "batch",
  "runtime": "node",
  "entryPoint": "bundle:observatory-inbox-normalizer@0.1.0#handler",
  "timeoutMs": 120000,
  "retryPolicy": {
    "maxAttempts": 3,
    "strategy": "exponential",
    "initialDelayMs": 5000
  },
  "parametersSchema": {
    "type": "object",
    "properties": {
      "minute": {
        "type": "string",
        "minLength": 1
      },
      "maxFiles": {
        "type": "number",
        "minimum": 1,
        "maximum": 2000
      },
      "commandPath": {
        "type": "string"
      },
      "filestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "filestoreBackendId": {
        "type": [
          "integer",
          "null"
        ],
        "minimum": 1
      },
      "filestoreToken": {
        "type": "string"
      },
      "inboxPrefix": {
        "type": "string",
        "minLength": 1
      },
      "stagingPrefix": {
        "type": "string",
        "minLength": 1
      },
      "archivePrefix": {
        "type": "string",
        "minLength": 1
      },
      "principal": {
        "type": "string"
      },
      "metastoreBaseUrl": {
        "type": "string"
      },
      "metastoreNamespace": {
        "type": "string"
      },
      "metastoreAuthToken": {
        "type": "string"
      },
      "calibrationsBaseUrl": {
        "type": "string"
      },
      "calibrationsNamespace": {
        "type": "string"
      },
      "calibrationsAuthToken": {
        "type": "string"
      },
      "filestoreBackendKey": {
        "type": "string",
        "minLength": 1
      }
    },
    "required": [
      "minute",
      "filestoreBaseUrl",
      "inboxPrefix",
      "stagingPrefix",
      "archivePrefix",
      "filestoreBackendKey"
    ]
  },
  "defaultParameters": {
    "maxFiles": 1000,
    "filestoreBaseUrl": "http://127.0.0.1:4300",
    "filestoreBackendId": 1,
    "inboxPrefix": "datasets/observatory/inbox",
    "stagingPrefix": "datasets/observatory/staging",
    "archivePrefix": "datasets/observatory/archive",
    "principal": "observatory-inbox-normalizer",
    "metastoreBaseUrl": null,
    "metastoreNamespace": "observatory.ingest",
    "metastoreAuthToken": null,
    "calibrationsBaseUrl": null,
    "calibrationsNamespace": "observatory.calibrations",
    "calibrationsAuthToken": null,
    "filestoreBackendKey": "observatory-event-driven-s3"
  },
  "outputSchema": {
    "type": "object",
    "properties": {
      "partitionKey": {
        "type": "string"
      },
      "minute": {
        "type": "string"
      },
      "instrumentCount": {
        "type": "number"
      },
      "recordCount": {
        "type": "number"
      },
      "backendMountId": {
        "type": "number"
      },
      "stagingPrefix": {
        "type": "string"
      },
      "stagingMinutePrefix": {
        "type": "string"
      },
      "files": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string"
            },
            "nodeId": {
              "type": "number"
            },
            "site": {
              "type": "string"
            },
            "instrumentId": {
              "type": "string"
            },
            "rows": {
              "type": "number"
            },
            "sizeBytes": {
              "type": "number"
            },
            "checksum": {
              "type": "string"
            },
            "calibration": {
              "type": [
                "object",
                "null"
              ],
              "properties": {
                "calibrationId": {
                  "type": "string"
                },
                "instrumentId": {
                  "type": "string"
                },
                "effectiveAt": {
                  "type": "string",
                  "format": "date-time"
                },
                "metastoreVersion": {
                  "type": [
                    "number",
                    "null"
                  ]
                }
              },
              "required": [
                "calibrationId",
                "instrumentId",
                "effectiveAt"
              ]
            }
          },
          "required": [
            "path",
            "rows"
          ]
        }
      },
      "normalizedAt": {
        "type": "string",
        "format": "date-time"
      },
      "calibrationsApplied": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "calibrationId": {
              "type": "string"
            },
            "instrumentId": {
              "type": "string"
            },
            "effectiveAt": {
              "type": "string",
              "format": "date-time"
            },
            "metastoreVersion": {
              "type": [
                "number",
                "null"
              ]
            }
          },
          "required": [
            "calibrationId",
            "instrumentId",
            "effectiveAt"
          ]
        }
      },
      "backendMountKey": {
        "type": [
          "string",
          "null"
        ]
      }
    },
    "required": [
      "partitionKey",
      "minute",
      "backendMountId",
      "stagingPrefix",
      "recordCount",
      "files",
      "normalizedAt"
    ]
  }
}
