{
  "$schema": "../../docs/schemas/example-config.schema.json",
  "configVersion": "1.0",
  "module": "github.com/apphub/examples/environmental-observatory-event-driven",
  "manifests": [
    {
      "path": "./service-manifests/service-manifest.json"
    },
    {
      "path": "./jobs/observatory-data-generator/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-inbox-normalizer/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-timestore-loader/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-visualization-runner/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-report-publisher/apphub.bundle.json",
      "kind": "bundle"
    }
  ],
  "placeholders": [
    {
      "name": "OBSERVATORY_DATA_ROOT",
      "description": "Base directory on the host where observatory datasets and artifacts are stored.",
      "default": "examples/environmental-observatory-event-driven/data"
    }
  ],
  "bootstrap": {
    "actions": [
      {
        "type": "setEnvDefaults",
        "description": "Capture optional observatory overrides provided via the CLI environment",
        "values": {
          "OBSERVATORY_FILESTORE_BACKEND_ID": "{{ env.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 }}"
        }
      },
      {
        "type": "ensureDirectories",
        "description": "Create local directories required by the observatory example",
        "directories": [
          "{{ placeholders.OBSERVATORY_DATA_ROOT }}/datasets/observatory/inbox",
          "{{ placeholders.OBSERVATORY_DATA_ROOT }}/staging",
          "{{ placeholders.OBSERVATORY_DATA_ROOT }}/archive",
          "{{ placeholders.OBSERVATORY_DATA_ROOT }}/plots",
          "{{ placeholders.OBSERVATORY_DATA_ROOT }}/reports"
        ]
      },
      {
        "type": "ensureFilestoreBackend",
        "description": "Provision the observatory filestore backend",
        "mountKey": "observatory-event-driven-local",
        "backend": {
          "kind": "local",
          "rootPath": "{{ placeholders.OBSERVATORY_DATA_ROOT }}"
        },
        "config": {
          "provisionedBy": "observatory-import"
        },
        "assign": {
          "variables": {
            "OBSERVATORY_FILESTORE_BACKEND_ID": "{{ outputs.lastFilestoreBackendId }}"
          }
        }
      },
      {
        "type": "writeJsonFile",
        "description": "Materialize the observatory runtime configuration",
        "path": "{{ paths.repoRoot }}/examples/environmental-observatory-event-driven/.generated/observatory-config.json",
        "content": {
          "paths": {
            "inbox": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/datasets/observatory/inbox",
            "staging": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/staging",
            "archive": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/archive",
            "plots": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/plots",
            "reports": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/reports"
          },
          "filestore": {
            "baseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
            "backendMountId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
            "token": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
            "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
            "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
            "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}"
          },
          "timestore": {
            "baseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
            "datasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
            "datasetName": "{{ env.OBSERVATORY_TIMESTORE_DATASET_NAME | default:Observatory Time Series }}",
            "tableName": "{{ env.OBSERVATORY_TIMESTORE_TABLE_NAME | default:observations }}",
            "storageTargetId": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_TARGET_ID | default:null }}",
            "authToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}"
          },
          "metastore": {
            "baseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
            "namespace": "{{ env.OBSERVATORY_METASTORE_NAMESPACE | default:observatory.reports }}",
            "authToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
          },
          "catalog": {
            "baseUrl": "{{ env.OBSERVATORY_CATALOG_BASE_URL | default:http://127.0.0.1:4000 }}",
            "apiToken": "{{ env.OBSERVATORY_CATALOG_TOKEN | default:dev-token }}"
          },
          "workflows": {
            "ingestSlug": "{{ env.OBSERVATORY_INGEST_WORKFLOW_SLUG | default:observatory-minute-ingest }}",
            "publicationSlug": "{{ env.OBSERVATORY_PUBLICATION_WORKFLOW_SLUG | default:observatory-daily-publication }}",
            "visualizationAssetId": "{{ env.OBSERVATORY_VISUALIZATION_ASSET_ID | default:observatory.visualizations.minute }}"
          }
        }
      },
      {
        "type": "applyWorkflowDefaults",
        "description": "Apply default parameters for observatory workflows",
        "workflows": [
          {
            "slug": "observatory-minute-data-generator",
            "defaults": {
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
              "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
              "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}",
              "filestorePrincipal": "observatory-data-generator",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-minute-ingest",
            "defaults": {
              "stagingDir": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/staging",
              "archiveDir": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/archive",
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
              "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
              "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}",
              "filestorePrincipal": "observatory-inbox-normalizer",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "timestoreBaseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
              "timestoreDatasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
              "timestoreDatasetName": "{{ env.OBSERVATORY_TIMESTORE_DATASET_NAME | default:Observatory Time Series }}",
              "timestoreTableName": "{{ env.OBSERVATORY_TIMESTORE_TABLE_NAME | default:observations }}",
              "timestoreStorageTargetId": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_TARGET_ID | default:null }}",
              "timestoreAuthToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-daily-publication",
            "defaults": {
              "timestoreBaseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
              "timestoreDatasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
              "timestoreAuthToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}",
              "plotsDir": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/plots",
              "reportsDir": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/reports",
              "metastoreBaseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
              "metastoreNamespace": "{{ env.OBSERVATORY_METASTORE_NAMESPACE | default:observatory.reports }}",
              "metastoreAuthToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
            }
          }
        ]
      }
    ]
  }
}
