{
  "$schema": "../../docs/schemas/example-config.schema.json",
  "configVersion": "1.0",
  "module": "github.com/apphub/examples/environmental-observatory-event-driven",
  "manifests": [
    {
      "path": "./service-manifests/service-manifest.json"
    },
    {
      "path": "./jobs/observatory-data-generator/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-inbox-normalizer/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-timestore-loader/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-visualization-runner/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-report-publisher/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-dashboard-aggregator/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-calibration-importer/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-calibration-planner/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./jobs/observatory-calibration-reprocessor/apphub.bundle.json",
      "kind": "bundle"
    },
    {
      "path": "./workflows/observatory-minute-data-generator.json",
      "kind": "workflow"
    },
    {
      "path": "./workflows/observatory-minute-ingest.json",
      "kind": "workflow"
    },
    {
      "path": "./workflows/observatory-daily-publication.json",
      "kind": "workflow"
    },
    {
      "path": "./workflows/observatory-dashboard-aggregate.json",
      "kind": "workflow"
    },
    {
      "path": "./workflows/observatory-calibration-import.json",
      "kind": "workflow"
    },
    {
      "path": "./workflows/observatory-calibration-reprocess.json",
      "kind": "workflow"
    }
  ],
  "placeholders": [
    {
      "name": "OBSERVATORY_DATA_ROOT",
      "description": "Base directory on the host where observatory datasets and artifacts are stored.",
      "default": "/tmp/apphub-observatory"
    }
  ],
  "bootstrap": {
    "actions": [
      {
        "type": "setEnvDefaults",
        "description": "Capture optional observatory overrides provided via the CLI environment",
        "values": {
          "OBSERVATORY_FILESTORE_BACKEND_ID": "{{ env.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 }}",
          "OBSERVATORY_TIMESTORE_STORAGE_ROOT": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/timestore/storage",
          "OBSERVATORY_TIMESTORE_CACHE_DIR": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/timestore/cache",
          "OBSERVATORY_TIMESTORE_STORAGE_DRIVER": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_DRIVER | default: env.TIMESTORE_STORAGE_DRIVER | default:local }}",
          "TIMESTORE_STORAGE_ROOT": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/timestore/storage",
          "TIMESTORE_QUERY_CACHE_DIR": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/timestore/cache",
          "TIMESTORE_STORAGE_DRIVER": "{{ env.TIMESTORE_STORAGE_DRIVER | default:local }}"
        }
      },
      {
        "type": "writeJsonFile",
        "description": "Materialize the observatory runtime configuration",
        "path": "{{ paths.repoRoot }}/examples/environmental-observatory-event-driven/.generated/observatory-config.json",
        "content": {
          "paths": {
            "inbox": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/datasets/observatory/inbox",
            "staging": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/staging",
            "archive": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/archive",
            "plots": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/plots",
            "reports": "{{ placeholders.OBSERVATORY_DATA_ROOT }}/reports"
          },
          "filestore": {
            "baseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
            "backendMountId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
            "token": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
            "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
            "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
            "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}",
            "visualizationsPrefix": "{{ env.OBSERVATORY_FILESTORE_VIS_PREFIX | default:datasets/observatory/visualizations }}",
            "reportsPrefix": "{{ env.OBSERVATORY_FILESTORE_REPORTS_PREFIX | default:datasets/observatory/reports }}"
          },
          "timestore": {
            "baseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
            "datasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
            "datasetName": "{{ env.OBSERVATORY_TIMESTORE_DATASET_NAME | default:Observatory Time Series }}",
            "tableName": "{{ env.OBSERVATORY_TIMESTORE_TABLE_NAME | default:observations }}",
            "storageTargetId": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_TARGET_ID | default:null }}",
            "authToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}",
            "storageDriver": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_DRIVER }}",
            "storageRoot": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_ROOT }}",
            "cacheDir": "{{ env.OBSERVATORY_TIMESTORE_CACHE_DIR }}"
          },
          "metastore": {
            "baseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
            "namespace": "{{ env.OBSERVATORY_METASTORE_NAMESPACE | default:observatory.reports }}",
            "authToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
          },
          "catalog": {
            "baseUrl": "{{ env.OBSERVATORY_CATALOG_BASE_URL | default:http://127.0.0.1:4000 }}",
            "apiToken": "{{ env.OBSERVATORY_CATALOG_TOKEN | default:dev-token }}"
          },
          "workflows": {
            "generatorSlug": "{{ env.OBSERVATORY_GENERATOR_WORKFLOW_SLUG | default:observatory-minute-data-generator }}",
            "ingestSlug": "{{ env.OBSERVATORY_INGEST_WORKFLOW_SLUG | default:observatory-minute-ingest }}",
            "publicationSlug": "{{ env.OBSERVATORY_PUBLICATION_WORKFLOW_SLUG | default:observatory-daily-publication }}",
            "aggregateSlug": "{{ env.OBSERVATORY_DASHBOARD_WORKFLOW_SLUG | default:observatory-dashboard-aggregate }}",
            "calibrationImportSlug": "{{ env.OBSERVATORY_CALIBRATION_WORKFLOW_SLUG | default:observatory-calibration-import }}",
            "reprocessSlug": "{{ env.OBSERVATORY_CALIBRATION_REPROCESS_WORKFLOW_SLUG | default:observatory-calibration-reprocess }}",
            "visualizationAssetId": "{{ env.OBSERVATORY_VISUALIZATION_ASSET_ID | default:observatory.visualizations.minute }}",
            "dashboard": {
              "overviewPrefix": "{{ env.OBSERVATORY_DASHBOARD_OVERVIEW_PREFIX | default:datasets/observatory/reports/overview }}",
              "lookbackMinutes": "{{ env.OBSERVATORY_DASHBOARD_LOOKBACK_MINUTES | default:720 | number }}"
            },
            "generator": {
              "instrumentCount": "{{ env.OBSERVATORY_GENERATOR_INSTRUMENT_COUNT | default: env.OBSERVATORY_INSTRUMENT_COUNT | default:3 | number }}"
            }
          }
        }
      },
    {
      "type": "applyWorkflowDefaults",
      "description": "Apply default parameters for observatory workflows",
      "workflows": [
          {
            "slug": "observatory-minute-data-generator",
            "defaults": {
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
              "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
              "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}",
              "filestorePrincipal": "observatory-data-generator",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "instrumentCount": "{{ env.OBSERVATORY_GENERATOR_INSTRUMENT_COUNT | default: env.OBSERVATORY_INSTRUMENT_COUNT | default:3 | number }}"
            }
          },
          {
            "slug": "observatory-minute-ingest",
            "defaults": {
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "inboxPrefix": "{{ env.OBSERVATORY_FILESTORE_INBOX_PREFIX | default:datasets/observatory/inbox }}",
              "stagingPrefix": "{{ env.OBSERVATORY_FILESTORE_STAGING_PREFIX | default:datasets/observatory/staging }}",
              "archivePrefix": "{{ env.OBSERVATORY_FILESTORE_ARCHIVE_PREFIX | default:datasets/observatory/archive }}",
              "filestorePrincipal": "observatory-inbox-normalizer",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "timestoreBaseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
              "timestoreDatasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
              "timestoreDatasetName": "{{ env.OBSERVATORY_TIMESTORE_DATASET_NAME | default:Observatory Time Series }}",
              "timestoreTableName": "{{ env.OBSERVATORY_TIMESTORE_TABLE_NAME | default:observations }}",
              "timestoreStorageTargetId": "{{ env.OBSERVATORY_TIMESTORE_STORAGE_TARGET_ID | default:null }}",
              "timestoreAuthToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-daily-publication",
            "defaults": {
              "timestoreBaseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
              "timestoreDatasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
              "timestoreAuthToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}",
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "filestorePrincipal": "observatory-visualization-runner",
              "visualizationsPrefix": "{{ env.OBSERVATORY_FILESTORE_VIS_PREFIX | default:datasets/observatory/visualizations }}",
              "reportsPrefix": "{{ env.OBSERVATORY_FILESTORE_REPORTS_PREFIX | default:datasets/observatory/reports }}",
              "metastoreBaseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
              "metastoreNamespace": "{{ env.OBSERVATORY_METASTORE_NAMESPACE | default:observatory.reports }}",
              "metastoreAuthToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-dashboard-aggregate",
            "defaults": {
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "filestorePrincipal": "observatory-dashboard-aggregator",
              "reportsPrefix": "{{ env.OBSERVATORY_FILESTORE_REPORTS_PREFIX | default:datasets/observatory/reports }}",
              "overviewPrefix": "{{ env.OBSERVATORY_DASHBOARD_OVERVIEW_PREFIX | default:datasets/observatory/reports/overview }}",
              "lookbackMinutes": "{{ env.OBSERVATORY_DASHBOARD_LOOKBACK_MINUTES | default:720 | number }}",
              "timestoreBaseUrl": "{{ env.OBSERVATORY_TIMESTORE_BASE_URL | default:http://127.0.0.1:4200 }}",
              "timestoreDatasetSlug": "{{ env.OBSERVATORY_TIMESTORE_DATASET_SLUG | default:observatory-timeseries }}",
              "timestoreAuthToken": "{{ env.OBSERVATORY_TIMESTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-calibration-import",
            "defaults": {
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "filestorePrincipal": "observatory-calibration-importer",
              "calibrationsPrefix": "{{ env.OBSERVATORY_FILESTORE_CALIBRATIONS_PREFIX | default:datasets/observatory/calibrations }}",
              "plansPrefix": "{{ env.OBSERVATORY_FILESTORE_PLANS_PREFIX | default:datasets/observatory/calibrations/plans }}",
              "catalogBaseUrl": "{{ env.OBSERVATORY_CATALOG_BASE_URL | default:http://127.0.0.1:4000 }}",
              "catalogApiToken": "{{ env.OBSERVATORY_CATALOG_TOKEN | default:dev-token }}",
              "metastoreBaseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
              "metastoreNamespace": "{{ env.OBSERVATORY_CALIBRATION_NAMESPACE | default:observatory.calibrations }}",
              "metastoreAuthToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
            }
          },
          {
            "slug": "observatory-calibration-reprocess",
            "defaults": {
              "catalogBaseUrl": "{{ env.OBSERVATORY_CATALOG_BASE_URL | default:http://127.0.0.1:4000 }}",
              "catalogApiToken": "{{ env.OBSERVATORY_CATALOG_TOKEN | default:dev-token }}",
              "filestoreBaseUrl": "{{ env.OBSERVATORY_FILESTORE_BASE_URL | default:http://127.0.0.1:4300 }}",
              "filestoreBackendId": "{{ variables.OBSERVATORY_FILESTORE_BACKEND_ID | default:1 | number }}",
              "filestoreToken": "{{ env.OBSERVATORY_FILESTORE_TOKEN | default:null }}",
              "filestorePrincipal": "observatory-calibration-reprocessor",
              "metastoreBaseUrl": "{{ env.OBSERVATORY_METASTORE_BASE_URL | default:http://127.0.0.1:4100 }}",
              "metastoreNamespace": "{{ env.OBSERVATORY_REPROCESS_NAMESPACE | default:observatory.reprocess.plans }}",
              "metastoreAuthToken": "{{ env.OBSERVATORY_METASTORE_TOKEN | default:null }}"
            }
          }
        ]
      }
    ]
  }
}
