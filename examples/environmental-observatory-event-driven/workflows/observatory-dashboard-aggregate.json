{
  "slug": "observatory-dashboard-aggregate",
  "name": "Observatory Dashboard Aggregate",
  "description": "Aggregate recent observatory readings and render the interactive overview dashboard.",
  "tasks": [
    {
      "id": "aggregate-dashboard",
      "name": "Aggregate dashboard",
      "job": {
        "slug": "observatory-dashboard-aggregator",
        "input": {
          "partitionKey": "{{ parameters.partitionKey }}",
          "reportsDir": "{{ parameters.reportsDir }}",
          "overviewDirName": "{{ parameters.overviewDirName }}",
          "lookbackMinutes": "{{ parameters.lookbackMinutes }}",
          "timestoreBaseUrl": "{{ parameters.timestoreBaseUrl }}",
          "timestoreDatasetSlug": "{{ parameters.timestoreDatasetSlug }}",
          "timestoreAuthToken": "{{ parameters.timestoreAuthToken }}"
        }
      }
    }
  ],
  "parametersSchema": {
    "type": "object",
    "properties": {
      "partitionKey": { "type": "string", "minLength": 1 },
      "reportsDir": { "type": "string", "minLength": 1 },
      "overviewDirName": { "type": "string", "minLength": 1 },
      "lookbackMinutes": { "type": "number", "minimum": 5, "maximum": 4320 },
      "timestoreBaseUrl": { "type": "string", "minLength": 1 },
      "timestoreDatasetSlug": { "type": "string", "minLength": 1 },
      "timestoreAuthToken": { "type": "string" }
    },
    "required": [
      "partitionKey",
      "reportsDir",
      "overviewDirName",
      "lookbackMinutes",
      "timestoreBaseUrl",
      "timestoreDatasetSlug"
    ]
  },
  "defaultParameters": {
    "reportsDir": "examples/environmental-observatory-event-driven/data/reports",
    "overviewDirName": "overview",
    "lookbackMinutes": 720,
    "timestoreBaseUrl": "http://127.0.0.1:4200",
    "timestoreDatasetSlug": "observatory-timeseries",
    "timestoreAuthToken": null
  },
  "triggers": [
    {
      "type": "manual"
    }
  ],
  "metadata": {
    "provisioning": {
      "eventTriggers": [
        {
          "name": "Observatory dashboard aggregate",
          "description": "Refresh the aggregate dashboard whenever new observatory partitions arrive.",
          "eventType": "observatory.minute.partition-ready",
          "eventSource": "observatory.timestore-loader",
          "predicates": [
            {
              "path": "$.payload.datasetSlug",
              "operator": "equals",
              "value": "{{ defaultParameters.timestoreDatasetSlug }}"
            }
          ],
          "parameterTemplate": {
            "partitionKey": "{{ event.payload.minute }}",
            "reportsDir": "{{ trigger.metadata.paths.reportsDir }}",
            "overviewDirName": "{{ trigger.metadata.dashboard.overviewDirName }}",
            "lookbackMinutes": "{{ trigger.metadata.dashboard.lookbackMinutes }}",
            "timestoreBaseUrl": "{{ trigger.metadata.timestore.baseUrl }}",
            "timestoreDatasetSlug": "{{ trigger.metadata.timestore.datasetSlug }}",
            "timestoreAuthToken": "{{ trigger.metadata.timestore.authToken }}"
          },
          "metadata": {
            "paths": {
              "reportsDir": "{{ defaultParameters.reportsDir }}",
              "overviewDirName": "{{ defaultParameters.overviewDirName | default: 'overview' }}"
            },
            "timestore": {
              "baseUrl": "{{ defaultParameters.timestoreBaseUrl }}",
              "datasetSlug": "{{ defaultParameters.timestoreDatasetSlug }}",
              "authToken": "{{ defaultParameters.timestoreAuthToken }}"
            },
            "dashboard": {
              "overviewDirName": "{{ defaultParameters.overviewDirName | default: 'overview' }}",
              "lookbackMinutes": "{{ defaultParameters.lookbackMinutes }}"
            }
          },
          "idempotencyKeyExpression": "dashboard-aggregate-{{ event.payload.minute }}",
          "status": "active"
        }
      ]
    }
  }
}
