{
  "slug": "observatory-minute-data-generator",
  "name": "Observatory Minute Data Generator",
  "version": 1,
  "description": "Produces synthetic minute-level CSV drops to simulate instrument readings arriving in the inbox.",
  "parametersSchema": {
    "type": "object",
    "properties": {
      "inboxDir": {
        "type": "string",
        "minLength": 1
      },
      "minute": {
        "type": "string",
        "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}$"
      },
      "rowsPerInstrument": {
        "type": "number",
        "minimum": 1,
        "maximum": 360
      },
      "intervalMinutes": {
        "type": "number",
        "minimum": 1,
        "maximum": 120
      },
      "seed": {
        "type": "number"
      },
      "filestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "filestoreBackendId": {
        "type": "number",
        "minimum": 1
      },
      "filestoreToken": {
        "type": "string"
      },
      "inboxPrefix": {
        "type": "string",
        "minLength": 1
      },
      "stagingPrefix": {
        "type": "string",
        "minLength": 1
      },
      "archivePrefix": {
        "type": "string",
        "minLength": 1
      },
      "filestorePrincipal": {
        "type": "string"
      }
    },
    "required": [
      "inboxDir",
      "minute",
      "filestoreBaseUrl",
      "filestoreBackendId",
      "inboxPrefix",
      "stagingPrefix",
      "archivePrefix"
    ]
  },
  "defaultParameters": {
    "inboxDir": "examples/environmental-observatory-event-driven/data/inbox",
    "rowsPerInstrument": 6,
    "intervalMinutes": 10,
    "filestoreBaseUrl": "http://127.0.0.1:4200",
    "filestoreBackendId": 1,
    "inboxPrefix": "datasets/observatory/inbox",
    "stagingPrefix": "datasets/observatory/staging",
    "archivePrefix": "datasets/observatory/archive",
    "filestorePrincipal": "observatory-data-generator",
    "filestoreToken": null
  },
  "steps": [
    {
      "id": "generate-synthetic-drop",
      "name": "Generate synthetic instrument readings",
      "type": "job",
      "jobSlug": "observatory-data-generator",
      "parameters": {
        "inboxDir": "{{ parameters.inboxDir }}",
        "minute": "{{ parameters.minute }}",
        "rowsPerInstrument": "{{ parameters.rowsPerInstrument }}",
        "intervalMinutes": "{{ parameters.intervalMinutes }}",
        "seed": "{{ parameters.seed }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "inboxPrefix": "{{ parameters.inboxPrefix }}",
        "stagingPrefix": "{{ parameters.stagingPrefix }}",
        "archivePrefix": "{{ parameters.archivePrefix }}",
        "principal": "{{ parameters.filestorePrincipal }}"
      },
      "storeResultAs": "syntheticDrop",
      "produces": [
        {
          "assetId": "observatory.inbox.synthetic",
          "partitioning": {
            "type": "timeWindow",
            "granularity": "minute",
            "format": "YYYY-MM-DDTHH:mm",
            "lookbackWindows": 1440
          },
          "schema": {
            "type": "object",
            "properties": {
              "generatedAt": {
                "type": "string",
                "format": "date-time"
              },
              "partitionKey": {
                "type": "string"
              },
              "inboxDir": {
                "type": "string"
              },
              "filestoreInboxPrefix": {
                "type": "string"
              },
              "filestoreBackendId": {
                "type": "number"
              },
              "rowsGenerated": {
                "type": "number"
              },
              "instrumentCount": {
                "type": "number"
              },
              "files": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "relativePath": {
                      "type": "string"
                    },
                    "filestorePath": {
                      "type": "string"
                    },
                    "instrumentId": {
                      "type": "string"
                    },
                    "site": {
                      "type": "string"
                    },
                    "rows": {
                      "type": "number"
                    }
                  },
                  "required": [
                    "relativePath",
                    "filestorePath",
                    "instrumentId",
                    "rows"
                  ]
                }
              }
            },
            "required": [
              "generatedAt",
              "partitionKey",
              "inboxDir",
              "filestoreInboxPrefix",
              "filestoreBackendId",
              "rowsGenerated",
              "instrumentCount",
              "files"
            ]
          }
        }
      ]
    }
  ],
  "triggers": [
    {
      "type": "manual"
    }
  ],
  "metadata": {
    "provisioning": {
      "schedules": [
        {
          "name": "Observatory minute data generator",
          "description": "Emit synthetic instrument drops every minute so downstream ingest and visualization workflows stay in sync.",
          "cron": "*/1 * * * *",
          "timezone": "UTC",
          "catchUp": false,
          "isActive": true,
          "parameters": {
            "inboxDir": "{{ defaultParameters.inboxDir }}",
            "rowsPerInstrument": "{{ defaultParameters.rowsPerInstrument }}",
            "intervalMinutes": "{{ defaultParameters.intervalMinutes }}",
            "filestoreBaseUrl": "{{ defaultParameters.filestoreBaseUrl }}",
            "filestoreBackendId": "{{ defaultParameters.filestoreBackendId }}",
            "filestoreToken": "{{ defaultParameters.filestoreToken }}",
            "inboxPrefix": "{{ defaultParameters.inboxPrefix }}",
            "stagingPrefix": "{{ defaultParameters.stagingPrefix }}",
            "archivePrefix": "{{ defaultParameters.archivePrefix }}",
            "filestorePrincipal": "{{ defaultParameters.filestorePrincipal }}"
          }
        }
      ]
    }
  }
}
