{
  "slug": "observatory-minute-ingest",
  "name": "Observatory Minute Ingest",
  "version": 1,
  "description": "Normalizes inbox CSVs and persists minute-level readings into Timestore.",
  "parametersSchema": {
    "type": "object",
    "properties": {
      "stagingDir": { "type": "string", "minLength": 1 },
      "archiveDir": { "type": "string", "minLength": 1 },
      "minute": { "type": "string", "minLength": 1 },
      "maxFiles": { "type": "number", "minimum": 1, "maximum": 200 },
      "filestoreBaseUrl": { "type": "string", "minLength": 1 },
      "filestoreBackendId": { "type": "number", "minimum": 1 },
      "filestoreToken": { "type": "string" },
      "inboxPrefix": { "type": "string", "minLength": 1 },
      "stagingPrefix": { "type": "string", "minLength": 1 },
      "archivePrefix": { "type": "string", "minLength": 1 },
      "filestorePrincipal": { "type": "string" },
      "commandPath": { "type": "string" },
      "timestoreBaseUrl": { "type": "string", "minLength": 1 },
      "timestoreDatasetSlug": { "type": "string", "minLength": 1 },
      "timestoreDatasetName": { "type": "string" },
      "timestoreTableName": { "type": "string" },
      "timestoreStorageTargetId": { "type": "string" },
      "timestoreAuthToken": { "type": "string" }
    },
    "required": [
      "stagingDir",
      "archiveDir",
      "minute",
      "filestoreBaseUrl",
      "filestoreBackendId",
      "inboxPrefix",
      "stagingPrefix",
      "archivePrefix",
      "timestoreBaseUrl",
      "timestoreDatasetSlug"
    ]
  },
  "defaultParameters": {
    "maxFiles": 64,
    "stagingDir": "examples/environmental-observatory-event-driven/data/staging",
    "archiveDir": "examples/environmental-observatory-event-driven/data/archive",
    "filestoreBaseUrl": "http://127.0.0.1:4200",
    "filestoreBackendId": 1,
    "inboxPrefix": "datasets/observatory/inbox",
    "stagingPrefix": "datasets/observatory/staging",
    "archivePrefix": "datasets/observatory/archive",
    "filestorePrincipal": "observatory-inbox-normalizer",
    "timestoreBaseUrl": "http://127.0.0.1:4100",
    "timestoreDatasetSlug": "observatory-timeseries",
    "timestoreDatasetName": "Observatory Time Series",
    "timestoreTableName": "observations"
  },
  "steps": [
    {
      "id": "normalize-inbox",
      "name": "Normalize inbox files",
      "type": "job",
      "jobSlug": "observatory-inbox-normalizer",
      "parameters": {
        "stagingDir": "{{ parameters.stagingDir }}",
        "archiveDir": "{{ parameters.archiveDir }}",
        "minute": "{{ parameters.minute }}",
        "maxFiles": "{{ parameters.maxFiles }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "inboxPrefix": "{{ parameters.inboxPrefix }}",
        "stagingPrefix": "{{ parameters.stagingPrefix }}",
        "archivePrefix": "{{ parameters.archivePrefix }}",
        "commandPath": "{{ parameters.commandPath }}",
        "principal": "{{ parameters.filestorePrincipal }}"
      },
      "storeResultAs": "normalizedOutput",
      "produces": [
        {
          "assetId": "observatory.timeseries.raw",
          "partitioning": {
            "type": "timeWindow",
            "granularity": "minute",
            "format": "YYYY-MM-DDTHH:mm",
            "lookbackWindows": 1440
          },
          "schema": {
            "type": "object",
            "properties": {
              "partitionKey": { "type": "string" },
              "minute": { "type": "string" },
              "instrumentCount": { "type": "number" },
              "recordCount": { "type": "number" },
              "sourceFiles": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "relativePath": { "type": "string" },
                    "site": { "type": "string" },
                    "instrumentId": { "type": "string" },
                    "rows": { "type": "number" }
                  },
                  "required": ["relativePath", "rows"]
                }
              },
              "stagingDir": { "type": "string" },
              "normalizedAt": { "type": "string", "format": "date-time" }
            },
            "required": ["partitionKey", "minute", "recordCount", "sourceFiles", "normalizedAt"]
          }
        }
      ]
    },
    {
      "id": "load-timestore",
      "name": "Ingest into Timestore",
      "type": "job",
      "jobSlug": "observatory-timestore-loader",
      "dependsOn": ["normalize-inbox"],
      "parameters": {
        "datasetSlug": "{{ parameters.timestoreDatasetSlug }}",
        "datasetName": "{{ parameters.timestoreDatasetName }}",
        "tableName": "{{ parameters.timestoreTableName }}",
        "timestoreBaseUrl": "{{ parameters.timestoreBaseUrl }}",
        "timestoreAuthToken": "{{ parameters.timestoreAuthToken }}",
        "storageTargetId": "{{ parameters.timestoreStorageTargetId }}",
        "partitionNamespace": "observatory",
        "minute": "{{ parameters.minute }}",
        "idempotencyKey": "{{ parameters.minute }}",
        "rawAsset": "{{ shared.normalizedOutput.normalized }}"
      },
      "storeResultAs": "timestoreIngestion",
      "consumes": [
        { "assetId": "observatory.timeseries.raw" }
      ],
      "produces": [
        {
          "assetId": "observatory.timeseries.timestore",
          "partitioning": {
            "type": "timeWindow",
            "granularity": "minute",
            "format": "YYYY-MM-DDTHH:mm",
            "lookbackWindows": 1440
          },
          "freshness": { "ttlMs": 60000 },
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 5
          },
          "schema": {
            "type": "object",
            "properties": {
              "partitionKey": { "type": "string" },
              "datasetSlug": { "type": "string" },
              "ingestionMode": { "type": "string" },
              "manifestId": { "type": "string" },
              "datasetId": { "type": "string" },
              "rowCount": { "type": "number" },
              "storageTargetId": { "type": "string" }
            },
            "required": ["partitionKey", "datasetSlug", "rowCount"]
          }
        }
      ]
    }
  ],
  "triggers": [
    { "type": "manual" }
  ]
}
