{
  "slug": "observatory-minute-ingest",
  "name": "Observatory Minute Ingest",
  "version": 1,
  "description": "Normalizes inbox CSVs and persists minute-level readings into Timestore.",
  "parametersSchema": {
    "type": "object",
    "properties": {
      "minute": {
        "type": "string",
        "minLength": 1
      },
      "maxFiles": {
        "type": "number",
        "minimum": 1,
        "maximum": 200
      },
      "filestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "filestoreBackendId": {
        "type": "number",
        "minimum": 1
      },
      "filestoreToken": {
        "type": "string"
      },
      "inboxPrefix": {
        "type": "string",
        "minLength": 1
      },
      "stagingPrefix": {
        "type": "string",
        "minLength": 1
      },
      "archivePrefix": {
        "type": "string",
        "minLength": 1
      },
      "filestorePrincipal": {
        "type": "string"
      },
      "commandPath": {
        "type": "string"
      },
      "timestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "timestoreDatasetSlug": {
        "type": "string",
        "minLength": 1
      },
      "timestoreDatasetName": {
        "type": "string"
      },
      "timestoreTableName": {
        "type": "string"
      },
      "timestoreStorageTargetId": {
        "type": "string"
      },
      "timestoreAuthToken": {
        "type": "string"
      }
    },
    "required": [
      "minute",
      "filestoreBaseUrl",
      "filestoreBackendId",
      "inboxPrefix",
      "stagingPrefix",
      "archivePrefix",
      "timestoreBaseUrl",
      "timestoreDatasetSlug"
    ]
  },
  "defaultParameters": {
    "maxFiles": 1,
    "filestoreBaseUrl": "http://127.0.0.1:4300",
    "filestoreBackendId": 1,
    "inboxPrefix": "datasets/observatory/inbox",
    "stagingPrefix": "datasets/observatory/staging",
    "archivePrefix": "datasets/observatory/archive",
    "filestorePrincipal": "observatory-inbox-normalizer",
    "timestoreBaseUrl": "http://127.0.0.1:4200",
    "timestoreDatasetSlug": "observatory-timeseries",
    "timestoreDatasetName": "Observatory Time Series",
    "timestoreTableName": "observations",
    "filestoreToken": null,
    "timestoreStorageTargetId": null,
    "timestoreAuthToken": null,
    "metastoreBaseUrl": null,
    "metastoreNamespace": "observatory.ingest",
    "metastoreAuthToken": null
  },
  "steps": [
    {
      "id": "normalize-inbox",
      "name": "Normalize inbox files",
      "type": "job",
      "jobSlug": "observatory-inbox-normalizer",
      "parameters": {
        "minute": "{{ parameters.minute }}",
        "maxFiles": "{{ parameters.maxFiles }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "inboxPrefix": "{{ parameters.inboxPrefix }}",
        "stagingPrefix": "{{ parameters.stagingPrefix }}",
        "archivePrefix": "{{ parameters.archivePrefix }}",
        "commandPath": "{{ parameters.commandPath }}",
        "principal": "{{ parameters.filestorePrincipal }}"
      },
      "storeResultAs": "normalizedOutput",
      "produces": [
        {
          "assetId": "observatory.timeseries.raw",
          "partitioning": {
            "type": "timeWindow",
            "granularity": "minute",
            "format": "YYYY-MM-DDTHH:mm",
            "lookbackWindows": 1440
          },
          "schema": {
            "type": "object",
            "properties": {
              "partitionKey": { "type": "string" },
              "minute": { "type": "string" },
              "instrumentCount": { "type": "number" },
              "recordCount": { "type": "number" },
              "backendMountId": { "type": "number" },
              "stagingPrefix": { "type": "string" },
              "stagingMinutePrefix": { "type": "string" },
              "files": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": { "type": "string" },
                    "nodeId": { "type": "number" },
                    "site": { "type": "string" },
                    "instrumentId": { "type": "string" },
                    "rows": { "type": "number" },
                    "sizeBytes": { "type": "number" },
                    "checksum": { "type": "string" }
                  },
                  "required": ["path", "rows"]
                }
              },
              "normalizedAt": { "type": "string", "format": "date-time" }
            },
            "required": [
              "partitionKey",
              "minute",
              "backendMountId",
              "stagingPrefix",
              "recordCount",
              "files",
              "normalizedAt"
            ]
          }
        }
      ]
    },
    {
      "id": "load-timestore",
      "name": "Ingest into Timestore",
      "type": "job",
      "jobSlug": "observatory-timestore-loader",
      "dependsOn": [
        "normalize-inbox"
      ],
      "parameters": {
        "datasetSlug": "{{ parameters.timestoreDatasetSlug }}",
        "datasetName": "{{ parameters.timestoreDatasetName }}",
        "tableName": "{{ parameters.timestoreTableName }}",
        "timestoreBaseUrl": "{{ parameters.timestoreBaseUrl }}",
        "timestoreAuthToken": "{{ parameters.timestoreAuthToken }}",
        "storageTargetId": "{{ parameters.timestoreStorageTargetId }}",
        "filestoreBaseUrl": "{{ parameters.filestoreBaseUrl }}",
        "filestoreBackendId": "{{ parameters.filestoreBackendId }}",
        "filestoreToken": "{{ parameters.filestoreToken }}",
        "filestorePrincipal": "{{ parameters.filestorePrincipal }}",
        "stagingPrefix": "{{ parameters.stagingPrefix }}",
        "partitionNamespace": "observatory",
        "minute": "{{ parameters.minute }}",
        "idempotencyKey": "{{ parameters.commandPath | default: parameters.minute }}",
        "rawAsset": "{{ shared.normalizedOutput.normalized }}"
      },
      "storeResultAs": "timestoreIngestion",
      "consumes": [
        {
          "assetId": "observatory.timeseries.raw"
        }
      ],
      "produces": [
        {
          "assetId": "observatory.timeseries.timestore",
          "partitioning": {
            "type": "timeWindow",
            "granularity": "minute",
            "format": "YYYY-MM-DDTHH:mm",
            "lookbackWindows": 1440
          },
          "freshness": {
            "ttlMs": 60000
          },
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 5
          },
          "schema": {
            "type": "object",
            "properties": {
              "partitionKey": {
                "type": "string"
              },
              "datasetSlug": {
                "type": "string"
              },
              "ingestionMode": {
                "type": "string"
              },
              "manifestId": {
                "type": "string"
              },
              "datasetId": {
                "type": "string"
              },
              "rowCount": {
                "type": "number"
              },
              "storageTargetId": {
                "type": "string"
              }
            },
            "required": [
              "partitionKey",
              "datasetSlug",
              "rowCount"
            ]
          }
        }
      ]
    }
  ],
  "triggers": [
    {
      "type": "manual"
    }
  ],
  "metadata": {
    "provisioning": {
      "eventTriggers": [
        {
          "name": "Observatory ingest on filestore upload",
          "description": "Kick off the minute ingest workflow whenever new observatory CSV uploads land in Filestore.",
          "eventType": "filestore.command.completed",
          "eventSource": "filestore.service",
          "predicates": [
            {
              "path": "$.payload.command",
              "operator": "equals",
              "value": "uploadFile"
            },
            {
              "path": "$.payload.backendMountId",
              "operator": "equals",
              "value": "{{ defaultParameters.filestoreBackendId }}"
            }
          ],
          "parameterTemplate": {
            "minute": "{{ event.payload.node.metadata.minute }}",
            "instrumentId": "{{ event.payload.node.metadata.instrumentId | default: event.payload.node.metadata.instrument_id | default: 'unknown' }}",
            "maxFiles": "{{ trigger.metadata.maxFiles }}",
            "filestoreBaseUrl": "{{ trigger.metadata.filestore.baseUrl }}",
            "filestoreBackendId": "{{ trigger.metadata.filestore.backendMountId }}",
            "filestoreToken": "{{ trigger.metadata.filestore.token }}",
            "inboxPrefix": "{{ trigger.metadata.filestore.inboxPrefix }}",
            "stagingPrefix": "{{ trigger.metadata.filestore.stagingPrefix }}",
            "archivePrefix": "{{ trigger.metadata.filestore.archivePrefix }}",
            "filestorePrincipal": "{{ trigger.metadata.filestore.principal | default: event.payload.principal }}",
            "commandPath": "{{ event.payload.path }}",
            "timestoreBaseUrl": "{{ trigger.metadata.timestore.baseUrl }}",
            "timestoreDatasetSlug": "{{ trigger.metadata.timestore.datasetSlug }}",
            "timestoreDatasetName": "{{ trigger.metadata.timestore.datasetName }}",
            "timestoreTableName": "{{ trigger.metadata.timestore.tableName }}",
            "timestoreStorageTargetId": "{{ trigger.metadata.timestore.storageTargetId }}",
            "timestoreAuthToken": "{{ trigger.metadata.timestore.authToken }}",
            "metastoreBaseUrl": "{{ trigger.metadata.metastore.baseUrl }}",
            "metastoreNamespace": "{{ trigger.metadata.metastore.namespace }}",
            "metastoreAuthToken": "{{ trigger.metadata.metastore.authToken }}"
          },
          "runKeyTemplate": "observatory-ingest-{{ parameters.instrumentId | default: 'unknown' | replace: ':', '-' }}-{{ parameters.minute | replace: ':', '-' }}",
          "metadata": {
            "maxFiles": "{{ defaultParameters.maxFiles }}",
            "filestore": {
              "baseUrl": "{{ defaultParameters.filestoreBaseUrl }}",
              "backendMountId": "{{ defaultParameters.filestoreBackendId }}",
              "token": "{{ defaultParameters.filestoreToken }}",
              "inboxPrefix": "{{ defaultParameters.inboxPrefix }}",
              "stagingPrefix": "{{ defaultParameters.stagingPrefix }}",
              "archivePrefix": "{{ defaultParameters.archivePrefix }}",
              "principal": "{{ defaultParameters.filestorePrincipal }}"
            },
            "timestore": {
              "baseUrl": "{{ defaultParameters.timestoreBaseUrl }}",
              "datasetSlug": "{{ defaultParameters.timestoreDatasetSlug }}",
              "datasetName": "{{ defaultParameters.timestoreDatasetName }}",
              "tableName": "{{ defaultParameters.timestoreTableName }}",
              "storageTargetId": "{{ defaultParameters.timestoreStorageTargetId }}",
              "authToken": "{{ defaultParameters.timestoreAuthToken }}"
            },
            "metastore": {
              "baseUrl": "{{ defaultParameters.metastoreBaseUrl }}",
              "namespace": "{{ defaultParameters.metastoreNamespace }}",
              "authToken": "{{ defaultParameters.metastoreAuthToken }}"
            }
          },
          "idempotencyKeyExpression": "{{ event.payload.node.metadata.minute }}-{{ event.payload.path | replace: '/', '_' | replace: ":", '-' }}",
          "status": "active"
        }
      ]
    }
  }
}
