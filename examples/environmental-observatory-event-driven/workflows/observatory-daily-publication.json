{
  "slug": "observatory-daily-publication",
  "name": "Observatory Visualization & Reports",
  "version": 1,
  "description": "Generates plots from Timestore partitions and publishes minute-level status reports with optional Metastore upserts.",
  "parametersSchema": {
    "type": "object",
    "properties": {
      "timestoreBaseUrl": {
        "type": "string",
        "minLength": 1
      },
      "timestoreDatasetSlug": {
        "type": "string",
        "minLength": 1
      },
      "timestoreAuthToken": {
        "type": "string"
      },
      "plotsDir": {
        "type": "string",
        "minLength": 1
      },
      "reportsDir": {
        "type": "string",
        "minLength": 1
      },
      "partitionKey": {
        "type": "string",
        "minLength": 1
      },
      "instrumentId": {
        "type": "string"
      },
      "lookbackMinutes": {
        "type": "number",
        "minimum": 1,
        "maximum": 10080
      },
      "siteFilter": {
        "type": "string"
      },
      "reportTemplate": {
        "type": "string"
      },
      "metastoreBaseUrl": {
        "type": "string"
      },
      "metastoreAuthToken": {
        "type": "string"
      },
      "metastoreNamespace": {
        "type": "string"
      }
    },
    "required": [
      "timestoreBaseUrl",
      "timestoreDatasetSlug",
      "plotsDir",
      "reportsDir",
      "partitionKey",
      "instrumentId"
    ]
  },
  "defaultParameters": {
    "lookbackMinutes": 180,
    "timestoreBaseUrl": "http://127.0.0.1:4200",
    "timestoreDatasetSlug": "observatory-timeseries",
    "plotsDir": "examples/environmental-observatory-event-driven/data/plots",
    "reportsDir": "examples/environmental-observatory-event-driven/data/reports",
    "metastoreBaseUrl": "http://127.0.0.1:4100",
    "metastoreNamespace": "observatory.reports",
    "timestoreAuthToken": null,
    "metastoreAuthToken": null,
    "instrumentId": null
  },
  "steps": [
    {
      "id": "generate-plots",
      "name": "Generate observatory plots",
      "type": "job",
      "jobSlug": "observatory-visualization-runner",
      "parameters": {
        "timestoreBaseUrl": "{{ parameters.timestoreBaseUrl }}",
        "timestoreDatasetSlug": "{{ parameters.timestoreDatasetSlug }}",
        "timestoreAuthToken": "{{ parameters.timestoreAuthToken }}",
        "plotsDir": "{{ parameters.plotsDir }}",
        "partitionKey": "{{ parameters.partitionKey }}",
        "instrumentId": "{{ parameters.instrumentId }}",
        "lookbackMinutes": "{{ parameters.lookbackMinutes }}",
        "siteFilter": "{{ parameters.siteFilter }}"
      },
      "storeResultAs": "visualizations",
      "consumes": [
        {
          "assetId": "observatory.timeseries.timestore"
        }
      ],
      "produces": [
        {
          "assetId": "observatory.visualizations.minute",
          "freshness": {
            "ttlMs": 86400000
          },
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 6
          },
          "schema": {
            "type": "object",
            "properties": {
              "generatedAt": {
                "type": "string",
                "format": "date-time"
              },
              "partitionKey": {
                "type": "string"
              },
              "plotsDir": {
                "type": "string"
              },
              "lookbackMinutes": {
                "type": "number"
              },
              "artifacts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "relativePath": {
                      "type": "string"
                    },
                    "mediaType": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    },
                    "sizeBytes": {
                      "type": "number"
                    }
                  },
                  "required": [
                    "relativePath",
                    "mediaType"
                  ]
                }
              },
              "metrics": {
                "type": "object",
                "additionalProperties": true
              }
            },
            "required": [
              "generatedAt",
              "partitionKey",
              "plotsDir",
              "artifacts"
            ]
          }
        }
      ]
    },
    {
      "id": "publish-report",
      "name": "Publish status report",
      "type": "job",
      "jobSlug": "observatory-report-publisher",
      "dependsOn": [
        "generate-plots"
      ],
      "parameters": {
        "reportsDir": "{{ parameters.reportsDir }}",
        "plotsDir": "{{ parameters.plotsDir }}",
        "partitionKey": "{{ parameters.partitionKey }}",
        "instrumentId": "{{ parameters.instrumentId }}",
        "reportTemplate": "{{ parameters.reportTemplate }}",
        "visualizationAsset": "{{ shared.visualizations.visualization }}",
        "metastoreBaseUrl": "{{ parameters.metastoreBaseUrl }}",
        "metastoreAuthToken": "{{ parameters.metastoreAuthToken }}",
        "metastoreNamespace": "{{ parameters.metastoreNamespace }}"
      },
      "consumes": [
        {
          "assetId": "observatory.visualizations.minute"
        }
      ],
      "produces": [
        {
          "assetId": "observatory.reports.status",
          "autoMaterialize": {
            "onUpstreamUpdate": true,
            "priority": 7
          },
          "schema": {
            "type": "object",
            "properties": {
              "generatedAt": {
                "type": "string",
                "format": "date-time"
              },
              "reportsDir": {
                "type": "string"
              },
              "reportFiles": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "relativePath": {
                      "type": "string"
                    },
                    "mediaType": {
                      "type": "string"
                    },
                    "sizeBytes": {
                      "type": "number"
                    }
                  },
                  "required": [
                    "relativePath",
                    "mediaType"
                  ]
                }
              },
              "summary": {
                "type": "object",
                "properties": {
                  "instrumentCount": {
                    "type": "number"
                  },
                  "siteCount": {
                    "type": "number"
                  },
                  "alertCount": {
                    "type": "number"
                  }
                }
              },
              "plotsReferenced": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "relativePath": {
                      "type": "string"
                    },
                    "altText": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "relativePath"
                  ]
                }
              }
            },
            "required": [
              "generatedAt",
              "reportsDir",
              "reportFiles"
            ]
          }
        }
      ]
    }
  ],
  "triggers": [
    {
      "type": "manual"
    }
  ],
  "metadata": {
    "provisioning": {
      "eventTriggers": [
        {
          "name": "Observatory publication on observatory partition",
          "description": "Generate plots and publish observatory reports when the ingest workflow emits a partition-ready event.",
          "eventType": "observatory.minute.partition-ready",
          "eventSource": "observatory.timestore-loader",
          "predicates": [
            {
              "path": "$.payload.datasetSlug",
              "operator": "equals",
              "value": "{{ defaultParameters.timestoreDatasetSlug }}"
            }
          ],
          "parameterTemplate": {
            "partitionKey": "{{ event.payload.partitionKey }}",
            "instrumentId": "{{ event.payload.instrumentId | default: 'unknown' }}",
            "minute": "{{ event.payload.minute }}",
            "rowsIngested": "{{ event.payload.rowsIngested }}",
            "timestoreBaseUrl": "{{ trigger.metadata.timestore.baseUrl }}",
            "timestoreDatasetSlug": "{{ trigger.metadata.timestore.datasetSlug }}",
            "timestoreAuthToken": "{{ trigger.metadata.timestore.authToken }}",
            "plotsDir": "{{ trigger.metadata.paths.plotsDir }}",
            "reportsDir": "{{ trigger.metadata.paths.reportsDir }}",
            "metastoreBaseUrl": "{{ trigger.metadata.metastore.baseUrl }}",
            "metastoreNamespace": "{{ trigger.metadata.metastore.namespace }}",
            "metastoreAuthToken": "{{ trigger.metadata.metastore.authToken }}"
          },
          "runKeyTemplate": "observatory-publish-{{ parameters.instrumentId | replace: ':', '-' }}-{{ parameters.partitionKey | replace: ':', '-' }}",
          "metadata": {
            "timestore": {
              "baseUrl": "{{ defaultParameters.timestoreBaseUrl }}",
              "datasetSlug": "{{ defaultParameters.timestoreDatasetSlug }}",
              "authToken": "{{ defaultParameters.timestoreAuthToken }}"
            },
            "paths": {
              "plotsDir": "{{ defaultParameters.plotsDir }}",
              "reportsDir": "{{ defaultParameters.reportsDir }}"
            },
            "metastore": {
              "baseUrl": "{{ defaultParameters.metastoreBaseUrl }}",
              "namespace": "{{ defaultParameters.metastoreNamespace }}",
              "authToken": "{{ defaultParameters.metastoreAuthToken }}"
            }
          },
          "idempotencyKeyExpression": "{{ event.payload.instrumentId | default: 'unknown' | replace: \":\", \"-\" }}-{{ event.payload.partitionKey | replace: \":\", \"-\" }}",
          "status": "active"
        }
      ]
    }
  }
}
